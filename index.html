<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 1;
    }

    img#overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80vw;
      opacity: 0.95;
      z-index: 2;
      cursor: move;
      touch-action: none;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      z-index: 3;
    }

    button {
      font-size: 16px;
      padding: 10px 20px;
      background: #ff4081;
      color: white;
      border: none;
      border-radius: 8px;
    }

    #preview {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 4;
    }

    #preview img {
      max-width: 90%;
      max-height: 80%;
    }
  </style>
</head>
<body>
  <video id="cam" autoplay playsinline></video>
  <img id="overlay" src="" alt="overlay">
  
  <div id="controls">
    <button id="prev">‚Üê Ââç„Å∏</button>
    <button id="capture">üì∏ ÊíÆÂΩ±</button>
    <button id="next">Ê¨°„Å∏ ‚Üí</button>
  </div>

  <div id="preview">
    <img id="previewImage" src="">
    <button id="download">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
    <button id="closePreview">ÊíÆ„ÇäÁõ¥„Åô</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // ‚úÖ Google Sheets„Åã„ÇâÈÖçÂàó„ÇíÂèó„ÅëÂèñ„ÇãÂΩ¢ÂºèÔºà‰æã: ?imgs=url1,url2,url3Ôºâ
    const params = new URLSearchParams(window.location.search);
    const imgsParam = params.get("imgs");
    const overlays = imgsParam ? imgsParam.split(",") : [];
    let currentIndex = 0;

    const overlay = document.getElementById("overlay");
    const video = document.getElementById("cam");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const previewImage = document.getElementById("previewImage");

    // ‚úÖ „Ç´„É°„É©Ëµ∑Âãï
    async function startCam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert("„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì: " + err);
      }
    }

    // ‚úÖ overlayÂàá„ÇäÊõø„Åà
    function updateOverlay() {
      if (overlays.length > 0) {
        overlay.src = overlays[currentIndex];
      }
    }

    document.getElementById("next").addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % overlays.length;
      updateOverlay();
    });

    document.getElementById("prev").addEventListener("click", () => {
      currentIndex = (currentIndex - 1 + overlays.length) % overlays.length;
      updateOverlay();
    });

    // ‚úÖ „Éâ„É©„ÉÉ„Ç∞ÁßªÂãï
    let isDragging = false, offsetX, offsetY;
    overlay.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - overlay.offsetLeft;
      offsetY = e.clientY - overlay.offsetTop;
    });
    window.addEventListener("mouseup", () => isDragging = false);
    window.addEventListener("mousemove", (e) => {
      if (isDragging) {
        overlay.style.left = `${e.clientX - offsetX}px`;
        overlay.style.top = `${e.clientY - offsetY}px`;
      }
    });

    // ‚úÖ ÊíÆÂΩ±„Éú„Çø„É≥
    document.getElementById("capture").addEventListener("click", () => {
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = overlay.src;
      img.onload = () => {
        const overlayRect = overlay.getBoundingClientRect();
        const scaleX = canvas.width / window.innerWidth;
        const scaleY = canvas.height / window.innerHeight;
        context.drawImage(
          img,
          overlayRect.left * scaleX,
          overlayRect.top * scaleY,
          overlayRect.width * scaleX,
          overlayRect.height * scaleY
        );

        const dataUrl = canvas.toDataURL("image/png");
        previewImage.src = dataUrl;
        preview.style.display = "flex";
      };
    });

    // ‚úÖ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    document.getElementById("download").addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "photo.png";
      link.href = previewImage.src;
      link.click();
      preview.style.display = "none";
    });

    // ‚úÖ ÊíÆ„ÇäÁõ¥„Åó
    document.getElementById("closePreview").addEventListener("click", () => {
      preview.style.display = "none";
    });

    // ÂàùÊúüÂåñ
    startCam();
    updateOverlay();
  </script>
</body>
</html>
