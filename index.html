<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; overflow:hidden; background:black; }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    #cam, #overlay, #preview {
      position: absolute;
      top:0; left:0;
      width:100%; height:100%;
      object-fit: contain;
    }
    #overlay {
      z-index:2; cursor:move; opacity:0.95;
      touch-action:none;
      transform-origin: center center;
      pointer-events:auto; 
    }
    #preview {
      display:none; z-index:3;
    }
    #buttons {
      position:absolute; bottom:20px; z-index:10; left:50%;
      transform:translateX(-50%);
      display:flex; gap:10px;
    }
    button {
      padding:10px 20px; font-size:16px; border:none;
      border-radius:8px; background:#ff4081; color:white;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="cam" autoplay playsinline></video>
    <img id="overlay" src="">
    <img id="preview">
  </div>
  <div id="buttons">
    <button id="capture">📸 撮影</button>
    <button id="retake" style="display:none;">🔄 撮り直す</button>
    <button id="save" style="display:none;">💾 保存</button>
    <button id="done" style="display:none;">✅ 完了</button>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    async function startCam() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      cam.srcObject = stream;
    }

    const params = new URLSearchParams(window.location.search);
    const imgURL = params.get("img");
    if (imgURL) document.getElementById("overlay").src = imgURL;

    const cam = document.getElementById("cam");
    const overlay = document.getElementById("overlay");
    const preview = document.getElementById("preview");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("capture");
    const retakeBtn = document.getElementById("retake");
    const saveBtn = document.getElementById("save");
    const doneBtn = document.getElementById("done");

    // ===== 移動と拡大縮小 =====
    let isDragging = false, startX=0, startY=0;
    let translateX = 0, translateY = 0;
    let scale = 1, startDist = 0, startScale = 1;

    overlay.addEventListener("mousedown", e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
    });

    window.addEventListener("mousemove", e => {
      if(isDragging){
        translateX += e.clientX - startX;
        translateY += e.clientY - startY;
        overlay.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        startX = e.clientX; startY = e.clientY;
      }
    });

    window.addEventListener("mouseup", ()=> isDragging=false);

    // タッチ移動
    overlay.addEventListener("touchstart", e => {
      if(e.touches.length === 1){
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      } else if(e.touches.length === 2){
        isDragging = false;
        startDist = Math.hypot(
          e.touches[1].clientX - e.touches[0].clientX,
          e.touches[1].clientY - e.touches[0].clientY
        );
        startScale = scale;
      }
    });

    overlay.addEventListener("touchmove", e => {
      if(e.touches.length === 1 && isDragging){
        translateX += e.touches[0].clientX - startX;
        translateY += e.touches[0].clientY - startY;
        overlay.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      } else if(e.touches.length === 2){
        const newDist = Math.hypot(
          e.touches[1].clientX - e.touches[0].clientX,
          e.touches[1].clientY - e.touches[0].clientY
        );
        scale = startScale * (newDist / startDist);
        overlay.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      }
    });

    overlay.addEventListener("touchend", ()=> isDragging=false);

    // ===== 撮影 =====
    captureBtn.addEventListener("click", ()=>{
      overlay.style.pointerEvents = "none";
      setTimeout(()=>{ overlay.style.pointerEvents = "auto"; }, 1000);
      canvas.width = cam.videoWidth;
      canvas.height = cam.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);

      const img = new Image();
      img.src = overlay.src;
      img.onload = ()=>{
        const overlayWidth = img.width * scale;
        const overlayHeight = img.height * scale;
        const x = (canvas.width/2 - overlayWidth/2) + translateX;
        const y = (canvas.height/2 - overlayHeight/2) + translateY;
        ctx.drawImage(img, x, y, overlayWidth, overlayHeight);

        preview.src = canvas.toDataURL("image/png");
        preview.style.display="block";
        captureBtn.style.display="none";
        retakeBtn.style.display="inline";
        saveBtn.style.display="inline";
        doneBtn.style.display="inline";
      };
    });

    // 撮り直し
    retakeBtn.addEventListener("click", ()=>{
      preview.style.display="none";
      captureBtn.style.display="inline";
      retakeBtn.style.display="none";
      saveBtn.style.display="none";
      doneBtn.style.display="none";
    });

    // 保存
    saveBtn.addEventListener("click", ()=>{
      const link = document.createElement("a");
      link.download = "photo.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    // 完了（Thunkableに戻る）
    doneBtn.addEventListener("click", ()=>{
      window.location.href = "thunkable://return";
    });

    startCam();
  </script>
</body>
</html>


