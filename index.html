<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin: 0; padding: 0;
  width: 100vw; height: 100vh;
  background: black; overflow: hidden;
}
#container {
  position: relative;
  width: 100vw; height: 100vw;
  max-height: 100vh;
  margin: 0 auto;
}
#cam, #overlay, #preview {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: cover;
}
#overlay {
  z-index: 2;
  cursor: grab;
  touch-action: none;
  transform-origin: center center;
  opacity: 1.0; /* â† ãã£ãã‚Š */
}
#preview {
  display: none;
  z-index: 3;
  background: black;
  object-fit: contain;
}
button {
  position: fixed;
  z-index: 4;
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #666;
  color: white;
}
#capture { bottom: 80px; left: 50%; transform: translateX(-50%); }
#switchCam { top: 12px; right: 12px; }
#saveHint {
  display: none;
  position: fixed;
  bottom: 140px; /* æ’®å½±ãƒœã‚¿ãƒ³ã‚ˆã‚Šå°‘ã—ä¸Š */
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 14px;
  text-align: center;
  z-index: 5;
  opacity: 0.8;
}

#postButtons {
  position: fixed;
  bottom: 80px;       /* æ’®å½±ãƒœã‚¿ãƒ³ã¨é‡ãªã£ã¦ã‚‚OK */
  left: 50%;
  transform: translateX(-50%);
  display: none;      /* æ’®å½±å‰ã¯éè¡¨ç¤º */
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 10px;
  z-index: 5;
}

#postButtons button {
  position: static;   /* é‡ãªã‚Šé˜²æ­¢ */
  background: #444;
  color: white;
  padding: 8px 16px;
  font-size: 12px;
  border: none;
  border-radius: 6px;
  min-width: 70px;   /* æ¨ªé•·ã§å°ã•ã‚ */
}
#save {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #555;
  color: white;
  padding: 8px 16px;
  font-size: 12px;
  border: none;
  border-radius: 6px;
  z-index: 6;
  display: none; /* æ’®å½±å‰ã¯éè¡¨ç¤º */
}


#canvas { display: none; }
</style>
</head>
<body>
<div id="container">
  <video id="cam" autoplay playsinline></video>
  <img id="overlay" src="">
  <img id="preview">
</div>

<button id="switchCam">ğŸ”„</button>
<button id="capture">ğŸ“¸ æ’®å½±</button>
<p id="saveHint">ğŸ“± é•·æŠ¼ã—ã§ä¿å­˜ã—ã¦ã­</p>
<div id="postButtons">
  <button id="retake">ğŸ”„ æ’®ã‚Šç›´ã™</button>
  <button id="done">âœ… å®Œäº†</button>
</div>
<button id="save">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
<canvas id="canvas"></canvas>

<script>
const cam = document.getElementById("cam");
const overlay = document.getElementById("overlay");
const preview = document.getElementById("preview");
const canvas = document.getElementById("canvas");
const captureBtn = document.getElementById("capture");
const postButtons = document.getElementById("postButtons");
const retakeBtn = document.getElementById("retake");
const saveBtn = document.getElementById("save");
const doneBtn = document.getElementById("done");
const switchBtn = document.getElementById("switchCam");
const saveHint = document.getElementById("saveHint");

let facing = "user"; // user: ã‚¤ãƒ³ã‚«ãƒ¡ãƒ© / environment: ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©

// ã‚«ãƒ¡ãƒ©èµ·å‹•
async function startCam() {
  if (window.stream) window.stream.getTracks().forEach(t => t.stop());
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } });
    cam.srcObject = stream;
    cam.style.transform = facing === "user" ? "scaleX(-1)" : "scaleX(1)";
    window.stream = stream;
  } catch (err) {
    alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: " + err);
  }
}

switchBtn.addEventListener("click", () => {
  facing = facing === "user" ? "environment" : "user";
  startCam();
});

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
const params = new URLSearchParams(window.location.search);
const imgURL = params.get("img");
if (imgURL) overlay.src = imgURL;

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ãƒ”ãƒ³ãƒæ“ä½œ
let isDragging=false, startX=0, startY=0, translateX=0, translateY=0, scale=1, startDist=0, startScale=1;
overlay.addEventListener("mousedown", e=>{ isDragging=true; startX=e.clientX; startY=e.clientY; });
window.addEventListener("mousemove", e=>{ if(isDragging){ translateX+=e.clientX-startX; translateY+=e.clientY-startY; overlay.style.transform=`translate(${translateX}px,${translateY}px) scale(${scale})`; startX=e.clientX; startY=e.clientY; }});
window.addEventListener("mouseup", ()=>isDragging=false);
overlay.addEventListener("touchstart", e=>{
  if(e.touches.length===1){ isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; }
  else if(e.touches.length===2){ isDragging=false; startDist=Math.hypot(e.touches[1].clientX-e.touches[0].clientX, e.touches[1].clientY-e.touches[0].clientY); startScale=scale; }
});
overlay.addEventListener("touchmove", e=>{
  e.preventDefault();
  if(e.touches.length===1 && isDragging){
    translateX+=e.touches[0].clientX-startX;
    translateY+=e.touches[0].clientY-startY;
    overlay.style.transform=`translate(${translateX}px,${translateY}px) scale(${scale})`;
    startX=e.touches[0].clientX; startY=e.touches[0].clientY;
  } else if(e.touches.length===2){
    const newDist=Math.hypot(e.touches[1].clientX-e.touches[0].clientX, e.touches[1].clientY-e.touches[0].clientY);
    scale=startScale*(newDist/startDist);
    overlay.style.transform=`translate(${translateX}px,${translateY}px) scale(${scale})`;
  }
});
overlay.addEventListener("touchend", ()=>isDragging=false);

// æ’®å½±å‡¦ç†
captureBtn.addEventListener("click", async () => {
  if (!cam.videoWidth) return alert("ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­ã§ã™");

  const ctx = canvas.getContext("2d");
  const squareSize = Math.min(cam.videoWidth, cam.videoHeight);
  canvas.width = squareSize;
  canvas.height = squareSize;

  ctx.save();
  if (facing === "user") {
    // ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©: é¡ã®ã‚ˆã†ã«è‡ªç„¶ï¼ˆåè»¢ã—ãŸã¾ã¾è¡¨ç¤ºï¼‰
    ctx.translate(squareSize, 0);
    ctx.scale(-1, 1);
  }

  const sx = (cam.videoWidth - squareSize) / 2;
  const sy = (cam.videoHeight - squareSize) / 2;
  ctx.drawImage(cam, sx, sy, squareSize, squareSize, 0, 0, squareSize, squareSize);
  ctx.restore();

  // --- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’åŒã˜ä½ç½®ã«é‡ã­ã‚‹ ---
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = overlay.src;
  await img.decode();

  const camRect = cam.getBoundingClientRect();
  const overlayRect = overlay.getBoundingClientRect();
  const scaleX = squareSize / camRect.width;
  const scaleY = squareSize / camRect.height;

  const drawX = (overlayRect.left - camRect.left) * scaleX;
  const drawY = (overlayRect.top - camRect.top) * scaleY;
  const drawWidth = overlayRect.width * scaleX;
  const drawHeight = overlayRect.height * scaleY;

  ctx.globalAlpha = 1.0; // â† é€ã‘ãªã„
  ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);

  preview.src = canvas.toDataURL("image/png");
  preview.style.display = "block";
  cam.style.display = "none";
  overlay.style.display = "none";
  captureBtn.style.display = "none";
  switchBtn.style.display = "none";
  postButtons.style.display = "flex";
  saveHint.style.display = "block";
  saveBtn.style.display = "block";
});

// æ’®ã‚Šç›´ã—
retakeBtn.addEventListener("click", () => {
  preview.style.display = "none";
  cam.style.display = "block";
  overlay.style.display = "block";
  captureBtn.style.display = "inline";
  switchBtn.style.display = "inline";
  postButtons.style.display = "none";
  saveHint.style.display = "none";
  saveBtn.style.display = "none";
});

// ä¿å­˜
saveBtn.addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = "photo.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});

// å®Œäº†
doneBtn.addEventListener("click", () => {
  window.location.href = "thunkable://return";
});

startCam();
</script>
</body>
</html>






