<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #000;
    margin: 0;
    height: 100vh;
    justify-content: center;
    overflow: hidden;
  }

  #camera-container {
    position: relative;
    width: 100vmin;
    height: 100vmin;
    overflow: hidden;
    background: black;
    touch-action: none;
  }

  #video {
    position: absolute;
    top: 50%;
    left: 50%;
    height: 100%;
    transform: translate(-50%, -50%) scaleX(-1); /* ãƒŸãƒ©ãƒ¼è¡¨ç¤º */
    object-fit: cover;
  }

  #overlay {
    position: absolute;
    border: 3px solid #00ffcc;
    border-radius: 10px;
    width: 60%;
    height: 60%;
    top: 20%;
    left: 20%;
    cursor: move;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 18px;
  }

  #canvas { display: none; }
</style>
</head>
<body>
  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
  </div>
  <button id="capture">æ’®å½±</button>
  <canvas id="canvas"></canvas>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const canvas = document.getElementById('canvas');
const captureButton = document.getElementById('capture');
const container = document.getElementById('camera-container');

// âœ… Thunkableã‹ã‚‰å—ã‘å–ã‚‹ç”»åƒURLï¼ˆä¾‹ï¼šå›ºå®šï¼‰
overlay.style.backgroundImage = 'url("https://via.placeholder.com/300x300.png?text=Overlay")';

// ðŸ“¸ ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ãƒ»ãƒŸãƒ©ãƒ¼è¡¨ç¤ºï¼‰
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
.then(stream => {
  video.srcObject = stream;
})
.catch(err => alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“: " + err));

// ðŸŸ¦ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
let isDragging = false, startX, startY, startLeft, startTop;
overlay.addEventListener("pointerdown", e => {
  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  const rect = overlay.getBoundingClientRect();
  startLeft = rect.left;
  startTop = rect.top;
  overlay.setPointerCapture(e.pointerId);
});

overlay.addEventListener("pointermove", e => {
  if (!isDragging) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  const containerRect = container.getBoundingClientRect();
  const newLeft = Math.min(Math.max(0, startLeft + dx - containerRect.left), containerRect.width - overlay.offsetWidth);
  const newTop = Math.min(Math.max(0, startTop + dy - containerRect.top), containerRect.height - overlay.offsetHeight);
  overlay.style.left = `${newLeft}px`;
  overlay.style.top = `${newTop}px`;
});

overlay.addEventListener("pointerup", () => {
  isDragging = false;
});

// ðŸŸ£ æ’®å½±å‡¦ç†
captureButton.addEventListener('click', () => {
  const containerRect = container.getBoundingClientRect();
  const overlayRect = overlay.getBoundingClientRect();

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  // ä¸­å¤®ãƒˆãƒªãƒŸãƒ³ã‚°ï¼ˆobject-fit: cover ç›¸å½“ï¼‰
  const videoAspect = vw / vh;
  const containerAspect = containerRect.width / containerRect.height;
  let cropX = 0, cropY = 0, cropW = vw, cropH = vh;
  if (videoAspect > containerAspect) {
    cropW = vh * containerAspect;
    cropX = (vw - cropW) / 2;
  } else {
    cropH = vw / containerAspect;
    cropY = (vh - cropH) / 2;
  }

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ç›¸å¯¾ä½ç½®ã‚’ç®—å‡º
  const relX = (overlayRect.left - containerRect.left) / containerRect.width;
  const relY = (overlayRect.top - containerRect.top) / containerRect.height;
  const relW = overlayRect.width / containerRect.width;
  const relH = overlayRect.height / containerRect.height;

  const sx = cropX + cropW * relX;
  const sy = cropY + cropH * relY;
  const sw = cropW * relW;
  const sh = cropH * relH;

  // æç”»
  canvas.width = overlayRect.width;
  canvas.height = overlayRect.height;
  const ctx = canvas.getContext('2d');

  // ðŸ” ãƒŸãƒ©ãƒ¼åè»¢ã—ã¦æ’®å½±
  ctx.save();
  ctx.scale(-1, 1);
  ctx.drawImage(video, sx, sy, sw, sh, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã‚’åˆæˆ
  const overlayImg = new Image();
  overlayImg.crossOrigin = "anonymous";
  overlayImg.src = overlay.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');

  overlayImg.onload = () => {
    ctx.drawImage(overlayImg, 0, 0, canvas.width, canvas.height);

    // çµæžœç”»åƒã‚’è¡¨ç¤ºï¼ˆor Thunkableã«è¿”ã™ï¼‰
    const imgData = canvas.toDataURL("image/png");
    const result = document.querySelector("#result-img") || (() => {
      const i = document.createElement("img");
      i.id = "result-img";
      i.style.width = "80vmin";
      i.style.height = "80vmin";
      document.body.appendChild(i);
      return i;
    })();
    result.src = imgData;
  };
});
</script>
</body>
</html>
